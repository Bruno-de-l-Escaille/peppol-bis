<?xml version="1.0" encoding="UTF-8"?>
<!--suppress AntResolveInspection -->
<project name="PEPPOL-BIS" basedir="." default="compile">

    <property name="agent.name" value="Manual generated"/>
    <!-- build.number is a property set by the build server (TeamCity) -->
    <!--<property name="build.number" value="DEV"/>-->
    <tstamp>
        <format property="build.time" pattern="yyyyMMdd_HHmmss" locale="en,GB"/>
    </tstamp>
    <property name="version.number" value="x.x.x.${build.time}"/>
    <!-- Format of version.releaseDate must be yyyy-mm-dd -->
    <!--<property name="version.releaseDate" value="2015-09-15"/>-->

    <property name="test.dir" value="../2.0/Test"/>
    <property name="target.dir" value="../target"/>
    <property name="target.xslt" value="${target.dir}/XSLT"/>
    <property name="test.output" value="${target.dir}/test-output.log"/>

    <taskdef resource="net/sf/antcontrib/antcontrib.properties">
        <classpath>
            <pathelement location="lib/ant-contrib-1.0b3.jar"/>
        </classpath>
    </taskdef>

    <target name="clean">
        <delete dir="../target"/>
    </target>

    <target name="init">
        <echo message="##teamcity[buildNumber '${version.number}']"/>
        <mkdir dir="${target.xslt}"/>
    </target>

    <target name="injectVersionNumber">
        <replaceregexp file="Build/iso_schematron_skeleton_oioubl.xsl"
                       match="name=&#34;dateRelease&#34; select=&#34;.*?'&#34;"
                       replace="name=&#34;dateRelease&#34; select=&#34;', ${version.releaseDate}, Version ${version.number}'&#34;"
                       byline="true"/>
    </target>


    <target name="compile" depends="clean, init">
        <foreach target="compileDocumentType" param="documentType">
            <path>
                <dirset dir="../2.0/Documents">
                    <include name="*"/>
                </dirset>
            </path>
        </foreach>
    </target>

    <target name="compileDocumentType" depends="dir.check" if="dir.exists">
        <basename property="baseDocumentType" file="${documentType}"/>
        <!--<echo message="${documentType}"/>-->
        <foreach target="compileSchFile" param="schFile">
            <path>
                <fileset dir="${documentType}/Schematron/">
                    <include name="*/*.sch"/>
                </fileset>
            </path>
        </foreach>
    </target>

    <target name="compileSchFile">
        <basename property="baseName" file="${schFile}" suffix=".sch"/>
        <echo message="##teamcity[compilationStarted compiler='${baseName}' flowId='12321']"/>

        <java jar="Saxon-HE-9.5.1-8.jar"
              fork="true"
              failonerror="true"
              maxmemory="2048m"
              resultproperty="errorCode">
            <arg value="-s:${schFile}"/>
            <arg value="-xsl:iso-schematron-xslt2/iso_dsdl_include.xsl"/>
            <arg value="-o:${target.xslt}/${baseName}.step1.xsl"/>
            <jvmarg line="-Xmx2048m"/>
        </java>

        <echo message="SCH: Staring step 2..."/>
        <java jar="Saxon-HE-9.5.1-8.jar"
              fork="true"
              failonerror="true"
              maxmemory="2048m"
              resultproperty="errorCode">
            <arg value="-s:${target.xslt}/${baseName}.step1.xsl"/>
            <arg value="-xsl:iso-schematron-xslt2/iso_abstract_expand.xsl"/>
            <arg value="-o:${target.xslt}/${baseName}.step2.xsl"/>
            <jvmarg line="-Xmx2048m"/>
        </java>

        <echo message="SCH: Staring step 3..."/>
        <java jar="Saxon-HE-9.5.1-8.jar"
              fork="true"
              failonerror="true"
              maxmemory="2048m"
              resultproperty="errorCode">
            <arg value="-s:${target.xslt}/${baseName}.step2.xsl"/>
            <!--<arg value="-xsl:iso-schematron-xslt2/iso_schematron_skeleton_for_saxon.xsl"/>-->
            <arg value="-xsl:iso-schematron-xslt2/iso_svrl_for_xslt2.xsl"/>
            <arg value="-o:${target.xslt}/${baseName}.step3.xsl"/>
            <jvmarg line="-Xmx2048m"/>
        </java>

        <move file="${target.xslt}/${baseName}.step3.xsl" tofile="${target.xslt}/${baseName}.xsl"/>
        <delete file="${target.xslt}/${baseName}.step1.xsl"/>
        <delete file="${target.xslt}/${baseName}.step2.xsl"/>
        <echo message="##teamcity[compilationFinished compiler='${baseName}' flowId='12321']"/>
    </target>

    <target name="dir.check">
        <condition property="dir.exists">
            <available file="${documentType}/Schematron" type="dir"/>
        </condition>
    </target>

    <target name="makeZip" depends="clean, compile" description="Make ZIP for release">
        <zip destfile="${target.dir}/OpenPEPPOL-Schematron_v${version.number}.zip">
            <fileset dir="${target.xslt}" includes="*.xsl"/>
        </zip>
    </target>

    <target name="test" depends="" description="Run all tests">
        <delete file="${test.output}"/>
        <!--<loadfile property="testConfig" srcfile="${test.dir}/test-config.txt"/>-->
        <!--<foreach target="handleTestLine" param="line" list="${testConfig}" delimiter="${line.separator}"/>-->

        <!-- For each test folder-->
        <foreach target="executeTest" param="testFile" inheritall="true">
            <path>
                <fileset dir="../2.0/Documents/">
                    <include name="**/Tests/T10-*.xml"/>
                </fileset>
            </path>
        </foreach>
        <delete file="${target.dir}/schematron-output.xml"/>

        <!--Check if errors exists-->
        <fileset id="matches" file="${test.output}">
            <contains text="ERROR"/>
        </fileset>

        <!--<fail message="Found ERRORS in tests">-->
        <!--<condition>-->
        <!--<resourcecount when="greater" count="0" refid="matches"/>-->
        <!--</condition>-->
        <!--</fail>-->
    </target>

    <target name="parseTestFilePath">
        <script language="javascript">
            // Find DocumentType
            filePath = project.getProperty('testFile');
            documentStartPos = filePath.indexOf('Documents\\');
            docType = filePath.substring(documentStartPos+10, documentStartPos+13);
            project.setProperty('docType', docType);
//            echo = project.createTask("echo");
//            echo.setMessage("TEST..................................................... " + filePath);
//            echo.perform( );
        </script>
        <basename property="testFile.base" file="${testFile}"/>
    </target>

    <target name="executeTest" depends="parseTestFilePath, schematronValidateFile">
        <echo message="${testFile}"/>
        <loadfile property="testFile.content" srcfile="${testFile}"/>
        <loadfile property="validationOutput.BII" srcfile="${target.dir}/schematron-BIIRULES-output.xml"/>
        <loadfile property="validationOutput.PEPPOL" srcfile="${target.dir}/schematron-OPENPEPPOL-output.xml"/>

        <script language="javascript"><![CDATA[
            // Parse test file for ERRORS and WARNINGS
            content = project.getProperty('testFile.content');
            commentStart = content.indexOf('<!--');
            commentEnd = content.indexOf('-->');
            commentLineArray = content.substring(commentStart, commentEnd).split('\n');
            var headlineFound = false;
            // Find ERRORS
            var errorArr = [];
            for (i=0; commentLineArray.length > i; i++) {
                <!--echo = project.createTask("echo");-->
                <!--echo.setMessage("TEST..................................................... " + commentLineArray[i].trim());-->
                <!--echo.perform( );-->
                if ( commentLineArray[i]!=null && commentLineArray[i].trim().indexOf('Errors:')>=0 ) {
                    headlineFound = true;
                    continue;
                }
                if ( headlineFound ) {
                    if ( commentLineArray[i]!=null && commentLineArray[i].trim().length() > 0  && commentLineArray[i].trim()!='None') {
                        errorArr.push(commentLineArray[i].trim())
                    } else {
                        break;
                    }
                }
            }
            // Find WARNINGS
            var warningArr = [];
            headlineFound = false;
            for (i=0; commentLineArray.length > i; i++) {
                if ( commentLineArray[i]!=null && commentLineArray[i].trim().indexOf('Warnings:')>=0 ) {
                    headlineFound = true;
                    continue;
                }
                if ( headlineFound ) {
                    if ( commentLineArray[i]!=null && commentLineArray[i].trim().length() > 0 && commentLineArray[i].trim()!='None' ) {
                        warningArr.push(commentLineArray[i].trim())
                    } else {
                        break;
                    }
                }
            }
            <!--echo = project.createTask("echo");-->
            <!--echo.setMessage("TEST..................................................... " + warningArr.length);-->
            <!--echo.perform( );-->


            // Verify that errors+warnings exists in schematron output
            var escapeChars = ["[", "]", "'"];
            validationOutput_BII = project.getProperty('validationOutput.BII');
            validationOutput_PEPPOL = project.getProperty('validationOutput.PEPPOL');
            // Errors
            for (i=0; errorArr.length > i; i++) {
                // if error code start with BII, when use BII schematron output
                testType = (errorArr[i].indexOf('BII')==0) ? 'BIIRULES' : 'OPENPEPPOL';
                validationOutput = testType=='BIIRULES' ? validationOutput_BII : validationOutput_PEPPOL;

                if ( validationOutput.indexOf(errorArr[i]) == -1 ) {
                    <!--for (var i = 0; escapeChars.length > i; i++) {-->
                        <!--errorArr[i] = errorArr[i].replace(escapeChars[i], "|"+escapeChars[i]);-->
                    <!--}-->

                    project.setProperty('test.errorCode', errorArr[i]);
                    project.setProperty('test.reason', "Error " + errorArr[i] + " not found in schematron output");
                    project.setProperty('test.result', "error");
                    project.setProperty('test.type', testType);
                    project.setProperty('validationOutput', validationOutput);
                    break;
                }
            }

            // Warnings
            for (i=0; warningArr.length > i; i++) {
                // if warning code start with BII, when use BII schematron output
                testType = (warningArr[i].indexOf('BII')==0) ? 'BIIRULES' : 'OPENPEPPOL';
                validationOutput = testType=='BIIRULES' ? validationOutput_BII : validationOutput_PEPPOL;

                if ( validationOutput.indexOf(warningArr[i]) == -1 ) {
                    <!--for (var i = 0; escapeChars.length > i; i++) {-->
                        <!--warningArr[i] = warningArr[i].replace(escapeChars[i], "|"+escapeChars[i]);-->
                    <!--}-->

                    project.setProperty('test.errorCode', warningArr[i]);
                    project.setProperty('test.reason', "Error " + warningArr[i] + " not found in schematron output");
                    project.setProperty('test.result', "error");
                    project.setProperty('test.type', testType);
                    project.setProperty('validationOutput', validationOutput);
                    break;
                }
            }


            // Test for no errors expected
            // If no errors expected and "failed-assert" is found - then fail test
            // BIIRULES
            if (errorArr.length == 0 && warningArr.length==0 && validationOutput_BII.indexOf("failed-assert") > 0 ) {
                project.setProperty('test.result', "error");
                project.setProperty('test.reason', "Error(s) found in BIIRULES output, where no errors were expected");
                project.setProperty('test.errorCode', "no errors");
                project.setProperty('test.type', 'BIIRULES');
                project.setProperty('validationOutput', validationOutput_BII);
            }

            // OPENPEPPOL
            if (errorArr.length == 0 && warningArr.length==0 && validationOutput_PEPPOL.indexOf("failed-assert") > 0 ) {
                project.setProperty('test.result', "error");
                project.setProperty('test.reason', "Error(s) found in OPENPEPPOL output, where no errors were expected");
                project.setProperty('test.errorCode', "no errors");
                project.setProperty('test.type', 'OPENPEPPOL');
                project.setProperty('validationOutput', validationOutput_PEPPOL);
            }
        ]]></script>
        <if>
            <equals arg1="${test.result}" arg2="error"/>
            <then>
                <echo message="##teamcity[testFailed name='${test.name}' message='${test.reason}' flowId='12321']"/>

                <echo message="ERROR: Output from ${test.type} schematron validation of the file ${testFile.base} - expected ${test.errorCode}:${line.separator}"
                      file="${test.output}" append="true"/>
                <echo message="${validationOutput}${line.separator}${line.separator}" file="${test.output}" append="true"/>
            </then>
        </if>
        <echo message="##teamcity[testFinished name='${test.name}' flowId='12321']"/>
    </target>

    <target name="schematronValidateFile">
        <property name="test.name" value="${docType}_${testFile.base}" environment=""/>

        <echo message="##teamcity[testStarted name='${test.name}' flowId='12321']"/>
        <!-- SAXON options: http://www.saxonica.com/documentation9.5/using-xsl/commandline.html -->
        <java jar="Saxon-HE-9.5.1-8.jar"
              fork="true"
              failonerror="true"
              maxmemory="2048m"
              resultproperty="errorCode">
            <arg value="-s:${testFile}"/>
            <arg value="-xsl:${target.xslt}/BIIRULES-UBL-${docType}.xsl"/>
            <arg value="-o:${target.dir}/schematron-BIIRULES-output.xml"/>
            <arg value="-warnings:silent"/>
            <jvmarg line="-Xmx2048m"/>
        </java>

        <java jar="Saxon-HE-9.5.1-8.jar"
              fork="true"
              failonerror="true"
              maxmemory="2048m"
              resultproperty="errorCode">
            <arg value="-s:${testFile}"/>
            <arg value="-xsl:${target.xslt}/OPENPEPPOL-UBL-${docType}.xsl"/>
            <arg value="-o:${target.dir}/schematron-OPENPEPPOL-output.xml"/>
            <arg value="-warnings:silent"/>
            <jvmarg line="-Xmx2048m"/>
        </java>
    </target>

    <!-- build-all is intended for build server. -->
    <target name="build-all" depends="clean, compile, test, makeZip"/>

</project>
